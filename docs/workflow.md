# ğŸ”„ Receipt Auto Logger - å·¥ä½œæµç¨‹è¯´æ˜

> **ç‰ˆæœ¬**: v1.2  
> **æ›´æ–°æ—¥æœŸ**: 2025-11-02

---

## ğŸ“‹ å®Œæ•´æµç¨‹å›¾

```
ğŸ“± ç”¨æˆ·æ“ä½œ                  ğŸ–¥ï¸ é¡µé¢/æ¨¡å—                      ğŸ”§ åç«¯ API
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. æ‹ç…§/é€‰æ‹©å›¾ç‰‡       â†’   image-handler.js
                            â†“
2. ç‚¹å‡»"å¼€å§‹è¯†åˆ«"      â†’   upload-handler.js
                            â†“ POST (action: 'ocr')
                                                        â†’   Code.gs
                                                            â†“
                                                            VisionAPI.gs
                                                            â†“
                                                            Parser.gs
                            â† JSON {result, ocrText}    â†   
                            â†“
3. è·³è½¬åˆ°ç¡®è®¤é¡µ         â†’   page-switcher.js
                            â†“
4. æ˜¾ç¤ºè¯†åˆ«ç»“æœ         â†’   confirm-handler.js
   ï¼ˆå¯ç¼–è¾‘è¡¨å•ï¼‰              renderData()
                            â†“
5. ç”¨æˆ·ä¿®æ”¹/ç¡®è®¤å      â†’   confirm-handler.js
   ç‚¹å‡»"æäº¤"                 submitToSheet()
                            â†“ POST (action: 'submit')
                                                        â†’   Code.gs
                                                            â†“
                                                            SheetWriter.gs
                            â† JSON {success: true}      â†
                            â†“
6. æ˜¾ç¤ºæˆåŠŸæç¤º         â†’   confirm-handler.js
   3ç§’åè‡ªåŠ¨è¿”å›              (setTimeout)
                            â†“
7. å›åˆ°ä¸Šä¼ é¡µ           â†’   page-switcher.js
```

---

## ğŸ“Š ç‰ˆæœ¬å¯¹æ¯”

### v1.1 vs v1.2

| æ­¥éª¤ | v1.1 | v1.2 |
|------|------|------|
| è¯†åˆ« | ä¸Šä¼  â†’ OCR â†’ å†™å…¥Sheet | ä¸Šä¼  â†’ OCRï¼ˆä¸å†™Sheetï¼‰ |
| ç¡®è®¤ | âŒ æ—  | âœ… ç¡®è®¤é¡µé¢ï¼ˆå¯ç¼–è¾‘ï¼‰ |
| æäº¤ | è‡ªåŠ¨ | æ‰‹åŠ¨æäº¤ï¼ˆäºŒæ¬¡ç¡®è®¤ï¼‰ |
| å‡†ç¡®æ€§ | ä¾èµ– OCR | ç”¨æˆ·å¯ä¿®æ­£é”™è¯¯ |

---

## ğŸ”€ æ¨¡å—è°ƒç”¨å…³ç³»

### å‰ç«¯æ¨¡å—ä¾èµ–å›¾

```
index.html
    â†“ åŠ è½½
    â”œâ”€ config.js          (é…ç½®)
    â”œâ”€ utils.js           (å·¥å…·å‡½æ•°)
    â”œâ”€ image-handler.js   (å›¾ç‰‡å¤„ç†)
    â”œâ”€ page-switcher.js   (é¡µé¢åˆ‡æ¢) â”€â”€â”
    â”œâ”€ confirm-handler.js (ç¡®è®¤é€»è¾‘) â†â”€â”¤
    â””â”€ upload-handler.js  (ä¸Šä¼ æµç¨‹) â”€â”€â”˜
```

### æ•°æ®æµå‘

```
ImageHandler.getCurrentFile()
    â†“
UploadHandler.uploadReceipt()
    â†“ sendRequest()
    â†“ (åç«¯: action='ocr')
    â†“
PageSwitcher.showConfirmPage(data, ocrText)
    â†“
ConfirmHandler.renderData(data, ocrText)
    â†“ (ç”¨æˆ·ç¼–è¾‘è¡¨å•)
    â†“
ConfirmHandler.submitToSheet()
    â†“ sendSubmitRequest()
    â†“ (åç«¯: action='submit')
    â†“
PageSwitcher.resetAllPages()
```

---

## ğŸ¯ å…³é”®å†³ç­–ç‚¹

### 1. ä¸ºä»€ä¹ˆè¯†åˆ«åä¸ç›´æ¥å†™ Sheetï¼Ÿ
- **åŸå› **: ç»™ç”¨æˆ·äºŒæ¬¡ç¡®è®¤çš„æœºä¼šï¼Œæé«˜æ•°æ®å‡†ç¡®æ€§
- **å¥½å¤„**: å¯ä»¥ä¿®æ­£ OCR é”™è¯¯ï¼ˆç‰¹åˆ«æ˜¯é‡‘é¢ã€æ—¥æœŸï¼‰

### 2. ä¸ºä»€ä¹ˆç”¨å•é¡µå¤šè§†å›¾è€Œä¸æ˜¯è·³è½¬æ–°é¡µï¼Ÿ
- **åŸå› **: ä¿æŒä¸Šä¸‹æ–‡ï¼Œé¿å…æ•°æ®ä¸¢å¤±
- **å¥½å¤„**: è¿”å›æ—¶æ— éœ€é‡æ–°ä¸Šä¼ å›¾ç‰‡

### 3. ä¸ºä»€ä¹ˆæäº¤æˆåŠŸåè‡ªåŠ¨è¿”å›ï¼Ÿ
- **åŸå› **: æµç•…çš„ç”¨æˆ·ä½“éªŒï¼Œæ”¯æŒæ‰¹é‡å¤„ç†
- **å¥½å¤„**: 3 ç§’å»¶è¿Ÿè¶³å¤Ÿç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º

---

## ğŸ”§ åç«¯ API æ¥å£

### è¯†åˆ«æ¥å£ (action: 'ocr')

**è¯·æ±‚**:
```json
{
    "action": "ocr",
    "token": "test123",
    "image_base64": "base64_string..."
}
```

**å“åº”**:
```json
{
    "success": true,
    "result": {
        "date": "2025-11-02",
        "amount": 1250,
        "store": "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³",
        "taxRate": "10%",
        "hasTNumber": "æœ‰",
        "confidence": "85%"
    },
    "ocrText": "åŸå§‹OCRæ–‡æœ¬...",
    "performance": {
        "ocrTime": "3500ms",
        "totalTime": "4200ms"
    }
}
```

### æäº¤æ¥å£ (action: 'submit')

**è¯·æ±‚**:
```json
{
    "action": "submit",
    "token": "test123",
    "data": {
        "date": "2025-11-02",
        "amount": 1250,
        "store": "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³",
        "taxRate": "10%",
        "hasTNumber": "æœ‰",
        "ocrText": "åŸå§‹OCRæ–‡æœ¬...",
        "confidence": 85
    }
}
```

**å“åº”**:
```json
{
    "success": true,
    "message": "æ•°æ®å·²å†™å…¥Sheet"
}
```

---

## ğŸ› å¸¸è§æµç¨‹é—®é¢˜

### é—®é¢˜ 1: è¯†åˆ«åå¡ä½ä¸è·³è½¬
**å¯èƒ½åŸå› **:
- `upload-handler.js` æœªè°ƒç”¨ `PageSwitcher.showConfirmPage()`
- `page-switcher.js` æœªæ­£ç¡®åŠ è½½
- åç«¯è¿”å›æ ¼å¼ä¸å¯¹ï¼ˆç¼ºå°‘ `ocrText`ï¼‰

**è¯Šæ–­**:
```javascript
// æµè§ˆå™¨æ§åˆ¶å°
console.log(typeof PageSwitcher);  // åº”è¯¥æ˜¯ "object"
```

### é—®é¢˜ 2: è¡¨å•å¡«å……å¤±è´¥
**å¯èƒ½åŸå› **:
- `confirm-handler.js` æœªåŠ è½½
- è¡¨å•å­—æ®µ ID ä¸åŒ¹é…
- `data` å¯¹è±¡ç¼ºå°‘å­—æ®µ

**è¯Šæ–­**:
```javascript
// æµè§ˆå™¨æ§åˆ¶å°
console.log(typeof ConfirmHandler);  // åº”è¯¥æ˜¯ "object"
```

### é—®é¢˜ 3: æäº¤å¤±è´¥
**å¯èƒ½åŸå› **:
- åç«¯æœªå®ç° `action: 'submit'` è·¯ç”±
- `SheetWriter.gs` å‚æ•°ä¸åŒ¹é…
- Sheet è¡¨å¤´æœªæ›´æ–°

**è¯Šæ–­**:
- F12 â†’ Network â†’ æŸ¥çœ‹ POST å“åº”

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **OCR é˜¶æ®µ** (~3-5ç§’)
   - å‹ç¼©å›¾ç‰‡ï¼ˆå‰ç«¯ï¼‰
   - ä½¿ç”¨ base64 ç¼–ç 

2. **é¡µé¢åˆ‡æ¢** (<100ms)
   - çº¯ CSS åˆ‡æ¢ï¼Œæ— é‡ç»˜
   - ä½¿ç”¨ `display: block/none`

3. **è¡¨å•æ¸²æŸ“** (<50ms)
   - ç›´æ¥æ“ä½œ DOM
   - æ— å¤æ‚è®¡ç®—

4. **æäº¤é˜¶æ®µ** (~2-4ç§’)
   - åªä¼ å¿…è¦å­—æ®µ
   - å¼‚æ­¥å†™å…¥ Sheet

---

**ç»´æŠ¤è€…**: @chenyongping  
**ç›¸å…³æ–‡æ¡£**: [context.md](context.md) | [README.md](../README.md)
